function V(e,t,n,r){let o=e/t*100;return console.log("progress is running",o),U(r,o)}function U(e,t){$("#popup-progress-bar-"+e).css("width",t+"%"),$("#progress-text-"+e).text(Math.round(t)+"%")}function Se(e,t,n,r){return e=w(e,t),{scene:e,view:t,recordId:n,body:r}}function Fe(e,t,n,r){e=w(e,t);let o={scene:e,view:t,records:n};return r&&(o.progressCbs=r),o}function Ae(e,t,n){return e=w(e,t),{scene:e,view:t,body:n}}function Me(e,t,n){return e=w(e,t),{scene:e,view:t,records:n}}function De({s:e,v:t,r:n}){return e=w(e,t),{scene:e,view:t,recordId:n}}function Ie({s:e,v:t,f:n,p:r,fmt:o,m:i}){e=w(e,t);let s={scene:e,view:t};return i&&(s.maxRecordsToGet=i),o||(o="both"),s.format=o,r&&(s.sceneRecordId=r.id),n&&(s.filters=n),s}function Ee({s:e,v:t,f:n}){return e=w(e,t),n?{url:`https://api.knack.com/v1/scenes/${e}/views/${t}/report/0`+"?filters="+encodeURIComponent(JSON.stringify(n)),isFilters:!0,scene:e,view:t,filters:n}:{scene:e,view:t}}function Le(e,t,n){return e=w(e,t),{recordId:n.id,scene:e,view:t}}function Oe(e,t,n){return e=w(e,t),{records:n,scene:e,view:t}}var N={getSingle:({s:e,v:t,r:n})=>De({s:e,v:t,r:n}),getMany:({s:e,v:t,f:n,p:r,fmt:o,m:i})=>Ie({s:e,v:t,f:n,p:r,fmt:o,m:i}),getManyReport:({s:e,v:t,f:n})=>Ee({s:e,v:t,f:n}),postSingle:(e,t,n)=>Ae(e,t,n),postMany:(e,t,n)=>Me(e,t,n),deleteSingle:(e,t,n)=>Le(e,t,n),deleteMany:(e,t,n)=>Oe(e,t,n),putSingle:(e,t,n,r)=>Se(e,t,n,r),putMany:(e,t,n,r)=>Fe(e,t,n,r)};function w(e,t){let o=Knack.scenes.models.find(i=>i.views.models.some(s=>s.attributes.key===t)).attributes.key;return o===e?e:(console.log("api payload - scenekey MISMATCH",o,e,o===e),o)}import Re from"https://cdn.skypack.dev/knack-api-helper@3.0.0";var I={delay(e){return new Promise(t=>setTimeout(t,e))},tools:{exponentialBackoff(e){return Math.pow(2,e-1)*1e3}},defaults:{retryDelay(e,t){return t.details.response.status===429?Math.pow(2,e-1)*1e3:1e3},retryOn(e,t){return!!(t.details&&t.details.response&&(t.details.response.status>=500||t.details.response.status===429))}},async wrapper(e,t={},n={}){try{let o=await fetch(e,t),i=await o.text(),s=null;if(r(i)&&(s=JSON.parse(i)),o&&o.ok)return{url:e,options:t,response:o,helperData:n,json:s,text:i};let a=new Error(`Successful http request but response.ok === false. Code: ${o.status}, Text: ${i}`);throw a.details={url:e,options:t,response:o,helperData:n,json:s,text:i},a}catch(o){throw o.details?o.datails:o.details={url:e,options:t,helperData:n},o}function r(o){try{return JSON.parse(o),!0}catch{return!1}}},async one(e={url,options,helperData,retries,retryDelay,retryOn}){if(typeof e!="object"||!e.url)throw new Error("Invalid argument when calling _fetch.one. You must call _fetch.one with an object (settings), containing at-minimum: settings = {url: string}");e.options||(e.options={method:"GET"}),e.options&&!e.options.method&&(e.options.method="GET"),!e.retries&&e.retries!==0&&(e.retries=5),typeof e.retryDelay!="function"&&typeof e.retryDelay!="number"&&(e.retryDelay=this.defaults.retryDelay),typeof e.retryOn!="function"&&(e.retryOn=this.defaults.retryOn);let t;for(let n=0;n<=e.retries;n++)try{if(n>0){let r;typeof e.retryDelay=="function"?r=e.retryDelay(n,t):r=e.retryDelay,await this.delay(r)}return await this.wrapper(e.url,e.options,e.helperData)}catch(r){if(n===e.retries||!await e.retryOn(n,r))throw r;t=r,console.log(`failed fetch ${e.options.method} to ${e.url}. Code: ${r.details&&r.details.response?r.details.response.status:""}. Attempt ${n}. Retrying...`)}},async many(e={requests,delayMs,progressCbs}){e.delayMs||(e.delayMs=125);let t=[];e.requests.forEach((o,i)=>{let s=(async()=>{await this.delay(i*e.delayMs);let a=await this.one({url:o.url,options:o.options,retries:o.retries,retryDelay:o.retryDelay,retryOn:o.retryOn,helperData:{request:o,delayMs:i*e.delayMs,i}});return r++,e.progressCbs&&e.progressCbs.length&&e.progressCbs.forEach(l=>{l(r,n,a)}),a})();t.push(s)});let n=t.length,r=0;return Promise.allSettled(t)}};var m={currencies:{code_5:"field_5"},fy:{year_18:"field_18",startDate_20:"field_20",endDate_21:"field_21"},profiles:{id_263:"field_263",name_264:"field_264",ref_265:"field_265"},accounts:{profile_274:"field_274",currency_168:"field_168",id_266:"field_266",ref_279:"field_279"},trTypes:{type_231:"field_231"},trParties:{name_239:"field_239",hash_255:"field_255"},trCategories:{code_244:"field_244",name_245:"field_245",hints_289:"field_289"},transactions:{currency_178:"field_178",fy_237:"field_237",profile_270:"field_270",account_179:"field_179",trType_247:"field_247",trParty_248:"field_248",id_177:"field_177",date_171:"field_171",amount_172:"field_172",forex_271:"field_271",details_236:"field_236",json_228:"field_228",bank_269:"field_269",dir_181:"field_181",categories_288:"field_288"}};function B(e){for(let t in e){if(!e.hasOwnProperty(t))continue;let n=e[t];typeof n=="object"&&n!==null?B(n):typeof n=="string"&&/^field_\d+$/.test(n)&&(e[t]={key:n,raw:`${n}_raw`})}}B(m);function G(e,t,n){let r=localStorage.getItem("knackDevMode");console.log("devMode",r);let o="https://bimsc-fas.netlify.app/.netlify/functions/"+t;return r==="true"&&(o="http://localhost:8888/.netlify/functions/"+t),{url:o,devUrl:"http://localhost:8888/.netlify/functions/"+t,request:{method:e,headers:{"Content-Type":"application/json",Authorization:Knack.getUserToken()},body:JSON.stringify({data:n})}}}var je=!1;async function Ve(e,t=!1){let n=y("GET-SINGLE",Date.now(),t,e),r=_();n.started();try{let o=await r.get(e);return n.completed(),o.json.records?.[0]??o.json??null}catch(o){return n.failed(o),null}}async function Ue(e,t="records"){let n=y("GET-MANY",Date.now(),je,e),r=_();n.started();try{let o=await r.getMany(e);if(n.completed(),t==="records")return o.records;if(t==="length")return o.pages[0].json.total_records}catch(o){return n.failed(o),null}}async function Ne(e,t=!1){let n=y("GET-MANY-FROM-PARENT",Date.now(),t,e);n.started();let r=e.url;var o=1;let i=`&page=${o}&rows_per_page=1000`,s=r+i;var a={};try{let d=await I.one(R("GET",s));if(a={...d},d.json.total_pages>1)for(var l=2;l<=d.json.total_pages;l++){i=`&page=${l}&rows_per_page=1000`,s=r+i;let c=await I.one(R("GET",s));a.json.records=[...a.json.records,...c.json.records]}return n.completed(),a.json.records}catch(d){return n.failed(d),null}}async function Be(e,t=!1){let n;if(e.isFilters){n=y("GET_MANY_REPORT-FILTERS",Date.now(),t,e),n.started();try{let r=await I.one(R("GET",e.url));return n.completed(),r.json.report.records}catch(r){return n.failed(r),null}}else{n=y("GET_MANY_REPORT",Date.now(),t,e),n.started();let r=_();try{let o=await r.getFromReportView(e);return n.completed(),o.json.reports[0].records}catch(o){return n.failed(o),null}}}async function Ge(e,t=!1){let n=y("POST-SINGLE",Date.now(),t,e),r=_();n.started();try{let i=(await r.post(e)).json;return n.completed(),i}catch(o){return n.failed(o),null}}async function He(e,t=!1){let n=y("POST-MANY",Date.now(),t,e),r=_();n.started();try{let o=await r.postMany(e);if(o.summary.rejected>0){let i=o.summary.rejected+o.summary.fulfilled,s=o.summary.rejected;n.failed(new Error(`failed ${s} out of ${i} `))}return n.completed(),o}catch(o){return n.failed(o),null}}async function ze(e,t=!1){let n=y("PUT-SINGLE",Date.now(),t,e),r=_();n.started();try{let o=await r.put(e);return n.completed(),o.json.record}catch(o){return n.failed(o),null}}async function Ke(e,t=!1){let n=y("PUT-MANY",Date.now(),t,e),r=_();n.started();try{let o=await r.putMany(e);if(o.summary.rejected>0){let i=o.summary.rejected+o.summary.fulfilled,s=o.summary.rejected;n.failed(new Error(`failed ${s} out of ${i} `))}return n.completed(),o}catch(o){return n.failed(o),null}}async function Je(e,t=!1){let n=y("DELETE-SINGLE",Date.now(),t,e),r=_();n.started();try{let o=await r.delete(e);return n.completed(),o}catch(o){return n.failed(o),null}}async function qe(e,t=!1){let n=y("DELETE-MANY",Date.now(),t,e),r=_();n.started();try{let o=await r.deleteMany(e);return n.completed(),o}catch(o){return n.failed(o),null}}var H={getSingle:e=>Ve(e),getMany:(e,t)=>Ue(e,t),getManyParentRecord:e=>Ne(e),getFromReport:e=>Be(e),postSingle:e=>Ge(e),postMany:e=>He(e),putMany:e=>Ke(e),putSingle:e=>ze(e),deleteSingle:e=>Je(e),deleteMany:e=>qe(e)};function y(e,t,n,r){let i=new Error().stack.split(`
`).map(a=>a.trim()).find(a=>a&&!a.includes("knack-api-calls.js")&&!a.includes("Error")),s={};return s.failed=a=>{console.log("api call: ",{status:"FAILED",type:e,callid:t,origin:i,error:a});let l={};l[m.apiErr.callType_2797.key]=e,l[m.apiErr.callOrigin_2839.key]=i,l[m.apiErr.callErr_2840.key]=a?.message||String(a),l[m.apiErr.callUrl_2841.key]=window.location.href,l[m.apiErr.callUser_2795.key]=Knack.session.user.id,r&&(l[m.apiErr.callPayload_2842.key]=JSON.stringify(r));let d=G("POST","api-error",l),c=fetch(d.url,d.request)},n&&(s.started=()=>console.log("api call: ",{status:"STARTED",type:e,callid:t,origin:i}),s.completed=()=>console.log("api call: ",{status:"COMPLETED",type:e,callid:t,duration:Date.now()-t,origin:i})),n||(s.started=()=>{},s.completed=()=>{}),s}function Ye(){return{Authorization:Knack.getUserToken(),"X-Knack-REST-API-Key":"knack","X-Knack-Application-Id":Knack.application_id,"Content-Type":"application/json"}}function _(){return new Re({auth:"view-based",applicationId:Knack.application_id,userToken:Knack.getUserToken()})}function R(e,t,n=5){return{url:t,options:{method:e,headers:Ye()},retries:n}}function z(e){return{match:e,rules:[]}}function K(e){return{isDuringTheCurrentMonth:{field:e,operator:"is during the current",type:"month"},isDuringThePreviousMonth:{field:e,operator:"is during the previous",range:"1",type:"months"},isDuringTheNextMonth:{field:e,operator:"is during the next",range:"1",type:"months"},isBeforeThePreviousMonth:{field:e,operator:"is before the previous",range:"1",type:"months"}}}var J={job:{job_uid:(e,t)=>({field:m.jobs.uid_329.key,operator:e,value:t}),job_date:(e,t)=>({field:m.jobs.date_338.key,operator:e,value:t}),job_site:(e,t)=>({field:m.jobs.site_510.key,operator:e,value:t})},presUser:{pu_id:(e,t)=>({field:m.pu.uid.key,operator:e,value:t})},quals:{active:(e,t)=>({field:m.quals.act.key,operator:e,value:t})}};function Xe(e){return new Promise(t=>setTimeout(t,e))}async function E(e,t,n){for(let r=0;r<n;r++){if(e())return!0;await Xe(t)}return!1}async function We(e,t=100,n=120){return await E(()=>$(e).length>0,t,n)?$(e):null}async function Qe(e,t,n=100,r=120){return await E(()=>$(e).length>=t,n,r)?$(e):null}async function Ze(e){if(await E(()=>{try{return Knack.views[e].render_count===0?(console.log(`Table ${e} not yet rendered, retrying...`),!1):!0}catch(n){return console.log(n),!1}},100,120))try{return Knack.models[e].data.models.map(n=>n.attributes)}catch{return[]}else return[]}async function et(e){return await E(()=>{try{let n=Knack.models[e].attributes.id!==void 0,r=Object.keys(Knack.models[e].attributes).length>1;return!!(n&&r)}catch{return!1}},100,120)?Knack.models[e].attributes:null}var L={records:e=>Ze(e),record:e=>et(e),element:(e,t,n)=>We(e,t,n),elements:(e,t,n,r)=>Qe(e,t,n,r)};function S(e=null,t=0){let n=window.location.hash.split("?")[1];if(!n)return e?null:{};let r=new URLSearchParams(n),o={};if(e){let i=`${e.key}_filters`;if(e.type==="report"&&(i=`${e.key}_${t}_filters`),r.has(i))try{let s=r.get(i);return JSON.parse(decodeURIComponent(s))}catch(s){return console.error(`Invalid JSON for filters [${i}]`,s),null}return null}for(let[i,s]of r.entries())if(/^view_\w+(_\d+)?_filters$/.test(i))try{o[i]=JSON.parse(decodeURIComponent(s))}catch(a){console.error(`Invalid JSON for filters [${i}]`,a)}return o}function tt(e,t){if(!t||!t.match||t.rules?.length===0){console.log("newFilters not correctly formatted");return}let n=S(e);if(!n){Knack.views[e.key].handleChangeFilters(t);return}let r;if(Array.isArray(n)?r={match:t.match,rules:n}:r=n,r.match!==t.match){console.log(`cannot mixe extgFilters '${r.match}' with newFiilters '${t.match}'`);return}let o=r.rules,i=t.rules;function s(f){let p=["val_label","field_name"];return Array.isArray(f)?f.map(s):f&&typeof f=="object"?Object.keys(f).filter(k=>!p.includes(k)).sort().reduce((k,g)=>(k[g]=s(f[g]),k),{}):f}function a(f){return JSON.stringify(s(f))}let l=o.map(f=>a(f)),d=i.filter(f=>{let p=a(f);return!l.includes(p)});if(d.length===0)return;let c=[...o,...d];r.rules=c,Knack.views[e.key].handleChangeFilters(r)}function nt(e,t){if(!t||!t.match||t.rules?.length===0){console.log("newFilters not correctly formatted");return}Knack.views[e.key].handleChangeFilters(t)}function rt(e){Knack.views[e.key].handleChangeFilters({})}function ot(e){let t=S(e);if(t&&Array.isArray(t)){let r=u.knAPI.filters.create("and");return r.rules=t,Knack.views[e.key].handleChangeFilters(r),!0}return!1}function at(e){var t=Knack.views[e].getFilters();Knack.views[e].handleChangeFilters(t)}function it(e){Knack.views[e].model.fetch(),setTimeout(function(){Knack.views[e].render(),Knack.views[e].postRender()},1e3)}function st(e){Knack.views[e].render()}var q={getViewFiltersFromUrl:S,addFiltersToTab:(e,t)=>tt(e,t),resetFiltersTab:(e,t)=>nt(e,t),normalizeFiltersTab:e=>ot(e),removeFilters:e=>rt(e),renderTabOrCal:e=>at(e),renderDet:e=>it(e),renderForm:e=>st(e)};function Y(e){let t=window.location.hash.split("?")[1];if(!t)return null;let n=new URLSearchParams(t),r=`${e.key}_search`;if(n.has(r))try{let o=n.get(r);return decodeURIComponent(o)}catch(o){return console.error(`Invalid search parameters [${r}]`,o),null}return null}var X={tableGrouping:async e=>{let t=await L.element(`#${e.key}-groups-rendered`);return t?t.length>0:!1}};function W(e){let t=e.description;if(!t)return{};let n=t.split("::");if(n.length<2)return{};let r=n[1].trim(),o={};return r.split(",").forEach(i=>{let[s,a]=i.split("=").map(l=>l.trim());s&&a!==void 0&&(o[s]=a)}),o}function lt(e,t){return $(`<span class="bimsc-sticker ${e}">${t}</span>`)}function ct(e){return $(`<div class="fas-pill" style="margin-right: 4px; margin-left: 4px;">${e}</div>`)}function dt(e){let t={go:"fas fa-check-circle",stop:"fas fa-hand",caution:"fas fa-triangle-exclamation",waiting:"fas fa-hourglass-half",proceed:"fas fa-hand-o-right",add:"fas fa-plus",expand:"fas fa-plus-square-o",collapse:"fas fa-minus-square-o",download:"fas fa-download",expandChevron:"fas fa-chevron-down",collapseChevron:"fas fa-chevron-up",todo:"fas fa-bolt",fill:"fas fa-fill",empty:"fas fa-eraser",remove:"fas fa-times-circle",cart:"fas fa-shopping-cart",save:"fas fa-bookmark",clone:"fas fa-clone"},n=t[e]||t.proceed;return $(`<i class="${n}" style="margin-right: 4px; margin-left: 4px;"></i>`)}function ut(){return $("<div>").addClass("overlay")}function ft(){return $("<div>").addClass("overlay-inner-container")}function pt(){return $("<div>").addClass("overlay-title")}function mt(){return $("<div>").addClass("overlay-content")}function kt(e,t){return $(`<tr id="${t.id}" class="bimsc-table-group bimsc-group-level-${t.level}">
            <td style="padding-top:4px; padding-bottom:0px" colspan="${e.find("thead th").length}">
                <div class="table-group-header">
                    <div class="table-group-label">
                        <span>${t.label}</span>
                    </div>
                    <div class="table-group-count">
                        <span>${t.records.length}</span>
                    </div>
                </div>
            </td>
        </tr>`)}function gt(e){return $(`
        <div class="table-group-header">
            <div class="table-group-label">
                <span>${e.label}</span>
            </div>
            <div class="table-group-count">
                <span>${e.records.length}</span>
            </div>
        </div>
        `)}function ht(){return $(`
        <td style="padding-top:4px; padding-bottom:0px">
            <div class="table-totals-header"></div>
        </td>
            `)}function yt(e,t){let r=e.find("th").length,o=$(`<tr id="${t.id}" class="bimsc-table-totals bimsc-totals-level-${t.level}"></tr>`);for(var i=0;i<r;i++){let s=ht();o.append(s)}for(let s of t.total.results){console.log(s.fKey,s.val);let a=s.val,d=e.find(`th.${s.fKey}`).first().index(),c=$(`<span>${t.total.label}${a}</span>`);o.find("td").eq(d).find(".table-totals-header").append(c)}return o}var M={stickers:(e,t)=>lt(e,t),icons:e=>dt(e),pills:ct,overlay:{cont:ut,innerCont:ft,title:pt,content:mt},groupRow:kt,totalsRow:yt,groupHeader:gt};function Q(e,t){let r=$(".fas-knack-ui-nav-menu").find(`#${e} a`),o=r.find(".fas-pill");if(o.length>0&&o.remove(),r.length>0&&t>0){let i=M.pills(t);r.append(i)}}async function $t(e){let t=$(`#${e.key}`),n=t.find(".view-header h2");if(n.length===0)return;let r=M.icons("expandChevron").attr("collapse","false"),o=M.icons("collapseChevron").attr("collapse","true"),i=await u.knUI.getFromPage.element(`#${e.key} [collapse]`),s=i.attr("collapse")==="true";t.children().each(function(){let a=$(this);a.hasClass("view-header")||(s?a.hide():a.show())}),i.remove(),n.prepend(s?r:o),window.scrollTo(window.scrollX,window.scrollY+1),window.scrollTo(window.scrollX,window.scrollY-1)}var Z={collapse:$t};var ee={routeTo:{jobCampaign:"https://eo1wnx7k40uu08l.m.pipedream.net",massSelection:"https://eow31n5i6dmb026.m.pipedream.net",freshDeskTicketCreate:"https://eozu7c2n87fkxsj.m.pipedream.net",freshDeskTicketReply:"https://eol3pd9gwb5ui64.m.pipedream.net",endPropsOnValidation:"https://eo4pixfzvpt74to.m.pipedream.net",pricingAnalysis:"https://eo61pljwl9h0729.m.pipedream.net",uploadPlgToDrive:"https://eo98604ae0y7x2f.m.pipedream.net"},send:(e,t)=>te(e,t)};async function te(e,t){let n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)};try{let r=await fetch(e,n);if(!r.ok)throw new Error("Network response was not ok");let o=await r.text();return console.log("Response from server:",o),o}catch(r){throw console.error("There was a problem with the request:",r),r}}function ne(e){return new DOMParser().parseFromString(e,"text/html").body.textContent||""}function re(e,t){let n=[];for(let r=0;r<e.length;r+=t)n.push(e.slice(r,r+t));return n}async function oe(e,t=125){let n=[];for(let r=0;r<e.length;r++)r>0&&await new Promise(o=>setTimeout(o,t)),n.push(e[r]);return Promise.all(n)}async function ae(e,t){window.JSONFormatter||await new Promise((o,i)=>{let s=document.createElement("script");s.src="https://cdn.jsdelivr.net/npm/json-formatter-js@2.5.13/dist/json-formatter.umd.js",s.onload=o,s.onerror=i,document.head.appendChild(s)}),console.log({string:e});let n=JSON.parse(e);console.log({obj:n});let r=new window.JSONFormatter(n,2);t.empty().append(r.render())}function vt(e){let t=e.date.slice(-4),n=e.date.substring(0,2),r=e.date.substring(3,5),o=Math.floor(e.time/60),i=e.time%60;return new Date(t,n-1,r,o,i)}function wt(e,t=!0){let n=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getFullYear()),i=`${n}/${r}/${o}`,s=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),l=t?`${s}:${a}`:"";return{date:i,time:l}}function _t(e){let t=String(e.getDate()).padStart(2,"0"),n=String(e.getMonth()+1).padStart(2,"0"),r=e.getFullYear(),o=`${t}/${n}/${r}`,i=e.getHours(),s=String(e.getMinutes()).padStart(2,"0"),a=i>=12?"pm":"am";return i=i%12||12,{date:o,hours:String(i).padStart(2,"0"),minutes:s,am_pm:a}}var ie={get:{fromKnackField:vt},set:{toKnackFilters:wt,toKnackAPI:_t}};var u={knAPI:{PL:N,calls:H,filters:{create:e=>z(e),common:e=>K(e),rules:J},fields:m,progress:(e,t,n,r)=>V(e,t,n,r)},knUI:{getFromPage:L,manipViews:q,getFromUrl:{filters:(e,t)=>S(e,t),search:e=>Y(e)},waitFor:X,diplayViews:Z,getViewCustomParams:W,addCounterToNavBtn:Q},pd:ee,generic:{html:{htmlToText:e=>ne(e),jsonToHtml:(e,t)=>ae(e,t)},js:{chunkArray:(e,t)=>re(e,t),staggerAll:(e,t)=>oe(e,t)}},dates:ie};$(document).on("knack-view-render.view_108",async function(e,t,n){$(`#${t.key}`).hide()});$(document).on("knack-view-render.view_103",function(e,t,n){$(`#${t.key}`).find("tbody").find("tr").each(function(){let a=$(this).find(".field_239"),l=a.find("span"),d=l.text().trim();if(d&&!a.find("a").length){let c=`https://www.google.com/search?q=${encodeURIComponent(d)}`;l.wrap(`<a href="${c}" target="_blank" rel="noopener noreferrer"></a>`)}})});$(document).on("knack-view-render.view_103",async function(e,t,n){let i=$(`#${t.key}`).find("thead").find("th"),s=await u.knUI.getFromPage.records("view_108"),a=await u.knUI.getFromPage.element("#view_108");for(let l of s){console.log(l);let c=a.find(`#${l.id}`).find("a").clone();c.removeAttr("href"),c.text(l.field_160_raw),console.log("tag cloned");let f=async()=>{let k=n.map(h=>({id:h.id,field_242:l.id})),g=u.knAPI.PL.putMany("scene_52","view_103",k),v=await u.knAPI.calls.putMany(g);u.knUI.manipViews.renderTabOrCal("view_103")};c.on("click",f),i.filter(function(){return $(this).text().trim()===l.field_160_raw}).find("span").html(c)}});function bt(e){return $(`
    <div class="kn-list-item-container kn-list-container column is-full" id="${e}" data-record-id="${e}" style="width:98%;">
        <section class="columns">
            <div class="kn-details-column first column is-horizontal " style="flex-basis: 100%"></div>
        </section>
    </div>
    `)}function Tt(e){return $(`<div class="kn-details-group column-${e} columns"></div>`)}function Ct(e,t){return $(`
            <div class="kn-details-group-column column">
                <div class="kn-label-${e} kn-table is-unbordered colnum-${t}"></div>
            </div>
            `)}function Pt(e,t){return $(`
            <div class="kn-label-${e} ${t}">
                <div class="kn-detail-label"></div>
            </div>
            `)}function xt(e){return $(`
        <div class="${e}">
            <div class="kn-detail-body"></div>
        </div>
            `)}function St(e){return $(`
        <div class="${e}">
            <div class="kn-details-link" style="display:flex; justify-content:center"></div>
        </div>
            `)}function Ft(e,t){e.find(".kn-details-column").append(t)}function At(e,t){e.append(t)}function Mt(e,t){e.find(".kn-table.is-unbordered").append(t)}function Dt(e,t){e.find(".kn-detail-label").append(t)}function It(e,t){e.find(".kn-detail-body").append(t)}function Et(e,t){e.find(".kn-details-link").append(t)}function Lt(e,t){let n=$(`#${e.key}`);for(var r of t){let o=n.find(`.${r}`);if(!o.length){console.warn(`No DOM element found for jobOffer ID: ${r.id}`);continue}o.hide()}}function Ot(e){return $(`<div class="kn-message is-error ${e}" style="padding-top: 5px; padding-bottom:5px;">
                <span class="kn-message-body">
                </span>
            </div>`)}function Rt(){}function jt(e,t){e.find(".kn-message-body").append(t)}function Vt(){}function Ut(){}var se={create:{card:bt,row:Tt,col:Ct,label:Pt,detail:xt,link:St,error:Ot,comment:Rt},append:{rowToCard:Ft,colToRow:At,fieldToCol:Mt},populate:{label:Dt,detail:It,link:Et,error:Vt,comment:Ut,error:jt},hide:{field:Lt}};function le(e,t=[]){let n=$('<div class="kn-button fas-knack-ui-button"></div>');return e instanceof $?n.append(e):typeof e=="string"?n.text(e):e instanceof Node&&n.append(e),n.on("click",function(){t.forEach(r=>{typeof r=="function"&&r($(this))})}),n}function ce(e,t){let n=$(`<div class="knViewLink kn-link kn-link-page knViewLink--page knViewLink--filled knViewLink--size-small knViewLink--rounded fas-knack-ui-button">${e}</div>`);return n.on("click",function(){t.forEach(r=>{typeof r=="function"&&r()})}),n}function de(e,t){let n=$('<button class="export-data kn-button is-button is-small"></button>');return n.append(e),n.on("click",function(){t.forEach(r=>{typeof r=="function"&&r()})}),n}function ue(e,t,n){let r=Nt(e,t),o=r.find("ul");return n.forEach((i,s)=>{let a=s===0?"is-active":"",l=$(`
            <li id= "${i.id}">
                <a><span>${i.label}</span></a>
            </li>
            `);l.on("click",function(){o.find("li").removeClass("is-active"),$(this).addClass("is-active"),i.events.forEach(d=>{typeof d=="function"&&d()})}),o.append(l)}),r}function Nt(e,t){return $(`
        <div class="bimsc-knack-ui-filter-menu ${e.toLowerCase()}">
            <div><b>${t}</b></div>
            <div class="js-filter-menu tabs is-toggle is-flush">
                <ul></ul>
            </div>
        </div>
    `)}function fe(e,t,n=!1){let r=n?'target="_blank" rel="noopener noreferrer"':"";return $(`<a href="${t}" ${r} class="knViewLink kn-link kn-link-page knViewLink--page knViewLink--filled knViewLink--size-small knViewLink--rounded fas-knack-ui-tag">${e}</a>`)}function pe(){let t=$(`
        <div class="kn-menu kn-view fas-knack-ui-nav-menu">
            <div class="menu-links">   
                <nav class="menu-links__nav">
                    <ul class="menu-links__list" style="display: flex; align-items: center;"></ul>
                </nav>
            </div>
        </div>
    `),n=$(`
        <li class="menu-links__list-item" style="margin-right:5px;">
            <div class="knMenuLink knMenuLink--button knMenuLink--filled knMenuLink--size-medium knMenuLink--rounded">
                <i class="fas fa-arrow-right" style="margin-right:4px;"></i>
                <div class="fas-menu-label">...</div>
            </div>
        </li>         
        `);return t.find("ul").append(n),t}function me(e){let t=$(`
            <li id="${e.id}" class="menu-links__list-item">
                <a href="${e.url}" data-kn-id="b03a3c3a-73d7-4bd3-8ef5-bb2dcee48886" class="knMenuLink knMenuLink--button knMenuLink--filled knMenuLink--size-medium knMenuLink--rounded" data-menu-link-count="1" data-vue-component="menuLink">
                    <div class="fas-nav"></div>                
                </a>
            </li> 
        `);e.icon||(e.icon="fa-file-alt");let n=$("<i>").addClass(`fa ${e.icon}`).css("margin-right","4px");return t.find(".fas-nav").append(n),e.active&&t.find("a").addClass("bimsc-is-active knMenuLink--isActive"),t.find(".fas-nav").append($(`<div class="fas-menu-label">${e.name}</div>`)),t}function ke(e,t=!0){let n=$(`
        <div class="kn-menu kn-view fas-knack-ui-section-menu">
            <div class="menu-links" style="display: flex; align-items: center; justify-content: center">
                <nav class="menu-links__nav">
                    <ul class="menu-links__list">         
                    </ul>
                </nav>
            </div>
        </div>
    `);for(let r of e){let o=$('<li class="menu-links__list-item"></li>'),i=$(`<div id="${r.label}" class="knMenuLink knMenuLink--button knMenuLink--filled knMenuLink--size-medium knMenuLink--rounded"></div>`);o.append(i);let s=$("<div>").text(r.label);i.append(s),r.icon&&i.prepend(o.icon),typeof r.event=="function"&&i.on("click",function(){n.find(".knMenuLink").removeClass("bimsc-is-active"),$(this).addClass("bimsc-is-active"),r.event()}),$(n).find("ul").append(o)}return t&&setTimeout(()=>{n.find(".knMenuLink").first().trigger("click")},100),n}function Bt(){return $(`
            <section class="columns">
                <div class="kn-details-column first column is-horizontal " style="flex-basis: undefined%"></div>
            </section>
    `)}function Gt(e){return $(`<div class="kn-details-group column-${e} columns"></div>`)}function Ht(e,t){return $(`
            <div class="kn-details-group-column column" data-fas-ui="$col">
                <div class="kn-label-${e} kn-table is-unbordered colnum-${t}"></div>
            </div>
            `)}function zt(e,t="left"){let n=t==="left"?"kn-detail":`kn-label-${t}`;return $(`<div class="${n} ${e}" data-fas-ui="$el"></div>`)}function Kt(e,t){return $('<div class="kn-detail-label"></div>')}function Jt(e){return $('<div class="kn-detail-body"></div>')}function qt(e){return $('<div class="kn-details-link" style="display:flex; justify-content:center;"></div>')}function Yt(e){return e.find("section.columns")}function Xt(e,t){e.find(".kn-details-column").append(t)}function Wt(e,t){e.append(t)}function Qt(e,t){e.find(".kn-table.is-unbordered").append(t)}function Zt(e,t){e.append(t)}function en(e,t){e.append(t)}function tn(e,t){e.append(t)}function nn(e,t){e.append(t)}var ge={create:{detail:Bt,row:Gt,col:Ht,el:zt,label:Kt,field:Jt,link:qt},populate:{label:en,field:tn,link:nn},append:{rowToDet:Xt,colToRow:Wt,elToCol:Qt,fldToEl:Zt},get:{detail:Yt}};var F={button:(e,t)=>le(e,t),linkButton:(e,t)=>ce(e,t),smallButton:de,filterMenuV1:(e,t,n)=>ue(e,t,n),navbar:{create:pe,addNavBtn:me},sectionBar:(e,t)=>ke(e,t),tag:(e,t,n)=>fe(e,t,n),card:se,detail:ge};var b={transactions:{updateCategory:sn},categories:{get:rn,updateParties:on,updateHints:he,addHint:an},hints:{add:ln,getFromCats:cn}};async function rn(){let e=u.knAPI.PL.getMany({s:"scene_66",v:"view_127"});return await u.knAPI.calls.getMany(e)}async function on(e,t){let n=u.knAPI.PL.putSingle("scene_80","view_153",e,t);return await u.knAPI.calls.putSingle(n)}async function he(e,t){let n={s:"scene_80",v:"view_152"},r=u.knAPI.PL.putSingle(n.s,n.v,e,{field_302:t});return await u.knAPI.calls.putSingle(r)}async function an(e,t){let n=[...e.field_302_raw.map(r=>r.id),t.id];return await he(e.id,n)}async function sn(e){let t={s:"scene_77",v:"view_147"},n=u.knAPI.PL.putMany(t.s,t.v,e);return await u.knAPI.calls.putMany(n)}async function ln(e){let t={s:"scene_76",v:"view_148"},n=u.knAPI.PL.postSingle(t.s,t.v,{field_299:e});return(await u.knAPI.calls.postSingle(n)).record}function cn(e){let t=[];for(let n of e){let r=n.field_302_raw;if(r.length!==0)for(let o of r)t.push({id:o.id,identifier:o.identifier,catId:n.id,catCode:n.field_244_raw})}return t}async function ye(e,t){let n=[{name:"fee1",code:"FEE",cat:t.find(a=>a.field_244_raw==="FEE"),rule:a=>{let l=["Wise Charges","Overseas ATM - Withdrawal - Fee","Foreign - Currency - Fee"],[d,c]=A(a.type),[f,p]=A(a.party),k=[x(c),x(p),x(a.details)];return l.some(g=>k.some(v=>v.includes(x(g))))},trs:[]}],r=t.map(a=>({id:a.id,partySet:new Set(a.field_296_raw.map(l=>l.id)),changed:!1})),o=t.map(a=>({id:a.id,code:a.field_244_raw,name:a.field_245_raw,rules:{trTypes:l=>{let d=a.field_294_raw;if(d.length===0)return!1;let[c,f]=A(l.type);return d.some(p=>c===p.id)},trParties:l=>{let d=a.field_296_raw;if(d.length===0)return!1;let[c,f]=A(l.party);return d.some(p=>c===p.id)},trWildCards:l=>{let d=a.field_302_raw;if(d.length===0)return!1;let[c,f]=A(l.type),[p,k]=A(l.party),g=[x(f),x(k),x(l.details)],v=d.some(h=>{let T=x(h.identifier);return g.some(C=>C.includes(T))});if(v){let h=r.find(O=>O.id===a.id),T=h.partySet.size;h.partySet.add(p),h.partySet.size>T&&(h.changed=!0)}return v}},trs:[]}));console.log("categories: ",o.map(a=>a.code));for(let a of e){let l=dn(a);a.categories=[];let d=!1;for(let c of n)if(d=c.rule(l),d){c.trs.push(l),a.categories.push({code:c.code,id:c.cat.id});break}if(!d)for(let c of o){let f=!1;for(let p of Object.values(c.rules))f=f||p(l);f===!0&&(a.categories.push({code:c.code,id:c.id}),c.trs.push(l))}}console.log("*****GLOBAL RULES");for(let a of n)console.log(`${a.code}: `,a.trs.length);console.log("*****RULE SETS");for(let a of o)a.trs.length>0&&console.log(`${a.code}: `,a.trs.length);console.log("MULTI CAT: ",e.filter(a=>a.categories.length>1).length);async function i(){let a=r.filter(d=>d.changed===!0).map(d=>({id:d.id,field_296:Array.from(d.partySet)}));console.log("CATEGORIES TO UPDATE",a.length);let l=u.knAPI.PL.putMany("scene_80","view_153",a);return await u.knAPI.calls.putMany(l)}await i();let s=e.filter(a=>{if(a.categories.length===0)return!1;if(a.field_288_raw.length===0)return!0;let l=a.categories.map(c=>c.id).sort().join("_"),d=a.field_288_raw.map(c=>c.id).sort().join("_");return l!==d}).map(a=>({id:a.id,field_288:a.categories.map(l=>l.id)}));if(console.log("TRANSACTIONS TO UPDATE",s.length),s.length>0){let a=await b.transactions.updateCategory(s);return!0}else return!1}function A(e){return[e[0].id,e[0].identifier]}function x(e){return e.toLowerCase().replace(/\s/g,"").replace(/'/g,"")}function dn(e){return{id:e.id,type:e[m.transactions.trType_247.raw],party:e[m.transactions.trParty_248.raw],details:e[m.transactions.details_236.raw],extgCategories:e[m.transactions.categories_288.raw]}}$(document).on("knack-view-render.view_125",async function(e,t,n){let r=n.filter(c=>c.field_288_raw.length===0),o=await b.categories.get();console.log({cats:o});let i=b.hints.getFromCats(o);if(console.log("hints",i),await ye(r,o)){u.knUI.manipViews.renderTabOrCal(t.key);return}let a=$(`#${t.key}`);function l(){let c=u.knUI.getFromUrl.search(t);if(console.log("search",c),!c)return;let p=a.find(".kn-records-nav").find(".table-keyword-search").css({display:"flex"}),k=pn(c,i);if(k!==!0){console.log("clash result: ",k);let h=un(c,k).appendTo(p);return}let g=$e(o).appendTo(p),v=F.button("Save Hint",[]).appendTo(p).hide();g.on("change",function(){let h=g.val(),T=o.find(C=>C.id===h);v.show().on("click",async function(){let C=await b.hints.add(c.trim());await b.categories.addHint(T,C),u.knUI.manipViews.renderTabOrCal(t.key)})})}l();function d(){for(let c of r){let f=a.find(`#${c.id}`),p=f.find(".field_288"),k=f.find(".field_247"),g=f.find(".field_248"),v=f.find(".field_236"),h=$("<div>").appendTo(p);p.find("span").remove();let T=$e(o).appendTo(h),C=$("<div>").appendTo(p),O=F.smallButton("Transaction",[]).appendTo(C).hide(),we=$("<div>").appendTo(k),mn=F.smallButton("Type",[]).appendTo(we).hide(),_e=$("<div>").appendTo(g),be=F.smallButton("Party",[]).appendTo(_e).hide(),Te=$("<div>").appendTo(v),kn=F.smallButton("Hints",[]).appendTo(Te).hide();T.on("change",function(){if(c.catVal=T.val(),c.catSel=o.find(P=>P.id===c.catVal),console.log("New value selected:",c),!c.catSel)return;let[j,Ce]=fn(c.field_248_raw),Pe=c.catSel.field_296_raw;o.some(P=>P.field_296_raw.some(D=>D.id===j))?console.log("This party is already associated",Ce):be.show().on("click",async function(){let P=c.catSel.id,D={field_296:[...Pe.map(xe=>xe.id),j]};console.log("parties record",P,D),await b.categories.updateParties(P,D),u.knUI.manipViews.renderTabOrCal("view_127"),u.knUI.manipViews.renderTabOrCal(t.key)}),O.show().on("click",async function(){let P=[{id:c.id,field_288:c.catSel.id}];await b.transactions.updateCategory(P),u.knUI.manipViews.renderTabOrCal(t.key)})})}}d()});function un(e,t){let n=$("<div>").css({display:"flex"}).addClass("input"),r=$("<div>").addClass("tag").text(e).appendTo(n),o=$("<div>").text("is conflicting with").appendTo(n);for(let i of t){let s=$("<div>").addClass("tag").text(`${i.identifier} - (${i.catCode})`).appendTo(n)}return n}function $e(e){let t=$("<select>",{id:"category-dropdown",name:"category",class:"kn-select input"}),n=$("<option>",{value:"",text:"Select a Category",disabled:!0,selected:!0}).appendTo(t);return e.forEach(r=>{let o=$("<option>",{value:r.id,text:r.field_244_raw}).appendTo(t)}),t}function fn(e){return[e[0].id,e[0].identifier]}function ve(e){return e.toLowerCase().replace(/\s/g,"").replace(/'/g,"")}function pn(e,t){let n=ve(e),r=t.filter(o=>{let i=ve(o.identifier);return i.includes(n)||n.includes(i)});return r.length===0?!0:r}
